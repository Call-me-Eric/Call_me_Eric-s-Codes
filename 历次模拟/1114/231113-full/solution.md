#

## D1T1

把 $a$ 排序。

如果 Alice 和 Bob 都往小了取，那么 Alice 可以得到所有奇数位置，而 Bob 可以得到所有偶数位置。

如果 Alice 和 Bob 都往大了取，那么 Alice 可以得到所有偶数位置，而 Bob 可以得到所有奇数位置。

如果以上两种有一种超出了 $[L,R]$ ，显然 Alice 必胜。

否则，把奇偶位置两两匹配，Bob 可以保证 Alice 只取到每个匹配中的一个，因此一定被 $\sum a_{2i-1}$ 和 $\sum a_{2i}$ 包在中间，因此属于 $[L,R]$ ，因此 Bob 必胜。

## D1T2

考虑对于一组固定的 $a,b,c$ 怎么判断胜负。

如果一个数 $x$ 在 $a_i,b_i,c_i$ 中出现了两次，那么无论 Alice 如何操作，Bob 都可以选到 $x$ ，因此 Alice 的最优操作就是让 Bob 在这一步只能拿走 $x$ 。设这样的 $x$ 组成的集合是 $S$ 。

只要 $S\ne \{1,2,\cdots,n\}$ ，Alice 就可以选择 $y\not\in S$ ，每一轮都删 $y$ ，Bob 就无论如何都不可能拿到 $y$ ，因此也不可能拿到两两不同的数。

所以 Alice 唯一一种必输的情况是 $S=\{1,2,\cdots,n\}$ 。考虑用 $n^n$ 减去 Alice 必输的方案数。

在 $a_i,b_i$ 之间连一条边，那么 $c_i$ 相当于决定这条边会匹配 $a_i$ 还是 $b_i$ 。不难发现图必须是基环树，不在环上的边只有唯一一种方案，长度不为 $1$ 的环有两种方案，长度为 $1$ 的环有 $n$ 种方案，乘起来即可。

## D1T3

显然每个数 $x$ 只关心 $l_x,r_x$ 表示其最左和最右的出现位置。

把询问离线下来，从左往右枚举 $R$ ，对每个 $L$ 维护 $[L,R]$ 的权值。

$R$ 发生变化时，对于所有 $r_x=R$ ，会把 $L\le l_x$ 的区间 $[L,R]$ 的权值对 $x$ 取 max ，因此是个前缀取 max 。

不难发现 $[L,R]$ 的权值关于 $L$ 是单调不增的，因此前缀取 max 简化为区间赋值。

处理询问时，需要求出一个区间的 $L$ 的历史和，这与区间赋值是相容的，可以线段树维护 3x3 矩阵乘法做。

## D1T4

先考虑怎么判断集合是否为空。

给每个数随机一个 $[0,2^{64})$ 的权值，定义一个集合的权值为里面所有数的权值的异或和，那么以极高概率，一个集合非空当且仅当其权值非零。

这个权值显然是非常好维护的，于是就做完了判断是否为空的情况。

怎么判断是否只有 $1$ 个呢？看权值是否是某个数的权值即可。

怎么判断是否只有 $2$ 个呢？

注意题目允许较大误差，因此可以搞一些乱搞的手段。

比如随机丢掉 $\frac 1 2$ 的点，看能不能抽离出其中一个权值。只要有一次成功，就可以搞到另一个权值了。

于是估计集合大小的手段也就呼之欲出了。我们不需要精细到抽离出一个权值，只需要判断集合是否非空即可。

设定 $p_1,\cdots,p_k$ ，以 $p_i$ 的概率随机丢掉一部分点，看得到的集合还是否非空。根据这几次抽样的结果，用最大似然法估计集合大小。

假设集合大小为 $x$ ，以 $c_i$ 的概率丢掉一个点时，有 $a_i$ 次得到空集、$b_i$ 次得到非空集，那么概率就是
$$
\prod (c_i^x)^{a_i}(1-c_i^x)^{b_i}
$$
最大似然就是要最大化这个概率的大小，即
$$
\text{argmax}_x \prod (c_i^x)^{a_i}(1-c_i^x)^{b_i}
$$
取对数，得到
$$
x \sum a_i \ln c_i + \sum b_i\ln (1-c_i^x)
$$
前半部分是一个线性函数，而后半部分是凸函数，因此可以三分出极值点。

也可以求导然后二分出导数为 $0$ 的点。其导数是
$$
\sum \frac{b_ic_i^x\ln c_i}{1-c_i^x} = \sum a_i\ln c_i
$$
标程共使用了 $24$ 个 $c_i$ ，每个 $c_i$ 采样了 $16$ 次，达到约 $0.13$ 的相对误差。
